<!-- Copyright (c) 2001-2006 ActiveState Software Inc. -->
<!-- See the file LICENSE.txt for licensing information. -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 1 September 2005), see www.w3.org" />
  <link rel="stylesheet" type="text/css" href="../css/screen.css" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="../favicon.ico" type=
  "image/x-icon" />

  <title>Ruby on Rails Tutorial</title>
</head>

<body>
  <h1><a name="rails_top" id="rails_top">Ruby on Rails
  Tutorial</a></h1>

  <h2><a name="rails_overview" id=
  "rails_overview">Overview</a></h2>

  <h3><a name="rails_prerequisites" id="rails_prerequisites">Before
  You Start</a></h3>

  <p>For this tutorial you will need:</p>

  <ul>
    <li>A recent local installation of <a target="_blank" href=
    "http://www.ruby-lang.org/en/downloads/">Ruby</a> (1.8.5 or
    later).</li>

    <li>A local installation of <a target="_blank" href=
    "http://www.rubyonrails.org/down">Rails</a>.</li>

    <li>Access to a <a target="_blank" href=
    "http://mysql.org/downloads/">MySQL</a> database.</li>
  </ul>

  <p>Several online "how to" guides are available for installing
  and configuring Ruby on Rails. See <a href=
  "#rails_resources">Rails Resources</a> for links to setup
  tutorials and installation bundles</p>

  <h3><a name="rails_scenario" id="rails_scenario">Tutorial
  Scenario</a></h3>

  <p>This tutorial walks you through the creation of a very simple
  Rails application. The Movie Lending Library application is a web
  application that allows you to add, remove, borrow and return
  movies from a shared library.</p>

  <p>Komodo has a very powerful Ruby on Rails project template with
  macros and commands for further automating the creation of Rails
  applications. The entire application can be created within Komodo
  using these tools and Komodo itself, without having to work at
  the command-line.</p>

  <p>In this tutorial you will:</p>

  <ol>
    <li>Create a new Rails scaffold using the Ruby on Rails Komodo
    project template.</li>

    <li>Create a MySQL database.</li>

    <li>Create the core of the application using just the project
    macros.</li>

    <li>Write some code to iteratively develop the Movie Library
    application.</li>

    <li>Debug the application.</li>
  </ol>

  <h2><a name="rails_template_new" id="rails_template_new">Creating
  a Rails Project</a></h2>

  <p>Komodo ships with a powerful template for Rails projects,
  containing several macros for:</p>

  <ul>
    <li>Creating and deleting databases</li>

    <li>Generating controllers, migrations, models and
    scaffolds</li>

    <li>Migrating databases</li>

    <li>Running Webrick (the built-in web-server for Rails)</li>

    <li>Debugging the application</li>
  </ul>

  <p>To create the tutorial project file:</p>

  <ol>
    <li>Make a new directory/folder in a convenient location (e.g.
    C:\rails on Windows, or /home/<em>username</em>/rails on OS X
    or Linux).</li>

    <li>In Komodo, select <strong>File|New|New Project from
    Template</strong>.</li>

    <li>In the New Project dialog box, select the <strong>Ruby on
    Rails</strong> template from the Common category.</li>

    <li>Give the file a useful name. Since this tutorial creates a
    movie lending library, let's call it
    <em>movielib.kpf</em>.</li>

    <li>Specify your working directory (the one created in the
    first step) in the <strong>Directory</strong> field. Use the
    <strong>Browse</strong> button to find it if you wish.</li>

    <li>Click <strong>Open</strong>.</li>
  </ol>

  <p>If Rails has been installed correctly, you should see a Komodo
  Alert dialog box saying "The movielib project is built". The
  movielib.kpf project should open in the <strong>Projects</strong>
  tab on the left, and should contain "<a href=
  "../folders.html">Live Folders</a>" of all the
  directories created by the <code>rails</code> command (app,
  components, config, db, etc.) plus a Virtual Folder containing
  the Komodo macros we'll be using.</p>

  <table align="center" width="60%">
    <tbody>
      <tr>
        <td class="startupBox">
          <p><strong>Komodo Tip</strong>: Komodo project templates
          can have a special macro called <code>oncreate</code>
          which run when a new project is created from the
          template. The <code>oncreate</code> macro in this Ruby on
          Rails template runs the command '<code>rails .
          --force</code>' in the current working directory to
          create the project.</p>
        </td>
      </tr>
    </tbody>
  </table>

  <p>Rails tools have a lot of third-party dependencies, and sometimes a new
  release of one of them can break the tools in the Rails project template. If
  a macro or command isn't working as expected, check the the <a target="_blank"
  href="http://community.activestate.com/faq-list">online FAQs</a> for possible
  solutions.</p>
  
  <h2><a name="rails_create_db" id="rails_create_db">Creating the
  Database</a></h2>

  <h3><a name="rails_edit_database_yml" id=
  "rails_edit_database_yml">Editing the database.yml file</a></h3>

  <p>If MySQL is installed locally and can accept connections by
  'root' without a password (it often is by default), click the
  <strong>Create Databases</strong> macro in the <strong>Rails
  Tools</strong> project folder to create the database.</p>

  <p>If you have set a MySQL root password, created another MySQL
  account that you would like to use, or are running the server on
  a different host, you will need to configure the
  <em>database.yml</em> file:</p>

  <ol>
    <li>Open the Config project folder and double-click
    <em>database.yml</em> to open it in an editor tab.</li>

    <li>As necessary, modify the <code>username</code> and
    <code>password</code> values to match the configuration of your
    MySQL server. If you're not sure what values to use, leave the
    default values ('<code>username: root</code>' and
    '<code>password:</code> '). In this tutorial, we will only be
    working with the <code>development</code> database, but you
    should modify the <code>test</code> and <code>production</code>
    sections as well to avoid errors with the <strong>Create
    Databases</strong> macro below.</li>

    <li>If you are running MySQL on a remote server, add the
    setting <code>hostname:</code> <em>host</em> to the
    <code>development:</code> configuration block, or modify the
    value if that setting is already present (set to
    <code>localhost</code> by default.</li>
  </ol>

  <p>If you would like to use a database server other than MySQL,
  consult the <a target="_blank" href=
  "http://www.rubyonrails.org/docs">Rails documentation</a> on
  configuring this file, making sure you have the necessary
  <a target="_blank" href=
  "http://wiki.rubyonrails.com/rails/pages/DatabaseDrivers">database
  drivers</a> installed, and creating the database manually. The
  database macros in the project will only work with MySQL.</p>

  <h3><a name="rails_create_databases_macro" id=
  "rails_create_databases_macro">Running the Create Databases
  Macro</a></h3>

  <p>In the Rails Tools project folder is a macro called
  <strong>Create Databases</strong>. Double-click the macro to run
  it.</p>

  <p>If the <em>database.yml</em> file (and the database server)
  are configured correctly, a database called
  <strong>movielib</strong> (as specified in the
  <em>database.yml</em> file - derived from the project name) will
  be created and an alert will appear indicating that the database
  creation is done.</p>

  <h2><a name="rails_generate_models" id=
  "rails_generate_models">Generating Models</a></h2>

  <p>Now that we have a directory tree with stub files, and a
  database for the application to use, we need to create our first
  model. At the command line we would use '<code>ruby
  script/generate model <em>name</em></code>', but in Komodo we
  have a macro to do that for us.</p>

  <p>In the Rails Tools/Generators project folder are macros for
  creating various parts of a Rails application. Double-click the
  <strong>model</strong> macro. A dialog-box appears prompting for
  a model name.</p>

  <h3><a name="rails_movie_model" id="rails_movie_model">The Movie
  Model</a></h3>

  <p>Since our application is a library for movies, we will need a
  movie model. Enter <code>movie</code> in the dialog box and click
  <strong>OK</strong>.</p>

  <p>The following output should appear in the <strong>Command
  Output</strong> tab showing the files created in this step:</p>
  <pre class="code">
      exists  app/models/
      exists  test/unit/
      exists  test/fixtures/
      create  app/models/movie.rb
      create  test/unit/movie_test.rb
      create  test/fixtures/movies.yml
      create  db/migrate
      create  db/migrate/001_create_movies.rb
</pre>

  <p>Komodo will also open these files in editor tabs. At this
  point we need to define the database table that this model will
  use. Click on the <em>001_create_movies.rb</em> editor tab (or
  open it from the db/migrate/ project folder). Notice that Rails
  has pluralized the name "movie" for the database table name.</p>

  <p>Add the following below the '<code>create_table :movies do
  |t|</code>' line:</p>
  <pre class="code">
      t.column :title, :string
      t.column :created_on, :date
</pre>

  <p>This is the file that will control the creation of the
  <code>movies</code> table in the database. The
  <code>create_table</code> line adds the table, and our additions
  create the columns '<code>title</code>' (a string) and
  '<code>created_on</code>' (a special Rails value for date
  stamping new records).</p>

  <h3><a name="rails_person_model" id="rails_person_model">The
  Person Model</a></h3>

  <p>We will need to track the name of the person borrowing a
  movie. We'll do this with a person model.</p>

  <p>Double-click on the <strong>model</strong> macro again. This
  time, specify <code>person</code> as the model name and click
  <strong>OK</strong>.</p>

  <p>The Command Output tab will again show us which files were
  created. The file we need to edit is
  <em>002_create_people.rb</em>. Add the following below the
  <code>create_table</code> line:</p>
  <pre class="code">
      t.column :name, :string
</pre>

  <p>With both models, Rails will automatically add a
  <code><em>tablename</em>_id</code> key for the table. We only
  need to add the "custom" fields.</p>

  <h3><a name="rails_checkout_model" id="rails_checkout_model">The
  Checkout Model</a></h3>

  <p>Now we need a way to link people with movies. We'll do this
  with a 'checkout' model. Double-click on the
  <strong>model</strong> macro again. This time, specify
  <code>checkout</code> as the model name and click
  <strong>OK</strong>.</p>

  <p>Add the following to to the newly created
  <em>003_create_checkouts.rb</em> below the
  '<code>create_table</code>' line:</p>
  <pre class="code">
      t.column :person_id, :integer, :null =&gt; false
      t.column :movie_id, :integer, :null =&gt; false
      t.column :created_on, :date
</pre>

  <h3><a name="rails_migration" id=
  "rails_migration">Migration</a></h3>

  <p>Now that we've defined the models in Rails, we need to apply
  them to our database. In Rails this is done with the '<code>rake
  migrate</code>' command. Again, there's a macro to do this for
  us.</p>

  <p>Double-click the <strong>db:migrate</strong> macro in Rails
  Tools|Migrate. The Command Output tab should show that the tables
  'movies', 'people' and 'checkouts' have been created.</p>

  <h2><a name="rails_generate_scaffold" id=
  "rails_generate_scaffold">Creating a Scaffold</a></h2>

  <p>Generating a scaffold is a quick way to get a skeletal,
  working Rails application that can be modified iteratively. Since
  most database driven web applications are very similar in their
  basic design, Rails builds a generic application based on the
  information in your models which you can then modify to meet your
  specific requirements.</p>

  <p>In the Generators folder, double-click the
  <strong>scaffold</strong> macro. In the dialog box enter
  <code>movie</code> as the model name, and <code>library</code> as
  the scaffold name. Click <strong>OK</strong></p>

  <p>Several files are created and opened in editor tabs. Since the
  tutorial won't be dealing with most of these files, feel free to
  close them to unclutter your workspace - they can all be opened
  from the project later as needed.</p>

  <h2><a name="rails_starting_webrick" id=
  "rails_starting_webrick">Starting the Webrick Server</a></h2>

  <p>At this point we have a working application. It's not yet
  useful as a lending library, but we can have a look at what we've
  got so far.</p>

  <p>In the Run folder, double-click the <strong>run
  server</strong> macro. This will start the the Webrick web server
  in a separate console.</p>

  <p>Open the <a target="_blank" href=
  "http://localhost:3000/library">http://localhost:3000/library</a>
  in your favourite web browser. You should see a "Listing movies"
  page with no data and a "New movie" link. This isn't actually
  usable yet, but we can leave the web server running and see our
  changes as we make them.</p>

  <h2><a name="rails_list_page" id="rails_list_page">Listing and
  Adding Movies</a></h2>

  <p>So far, the main Library page doesn't tell us much. We need to
  create a basic listing page to view the library contents.</p>

  <p>Open the <em>list.rhtml</em> file from the app/views/library
  project directory, or click on it's editor tab if it is already
  open. Replace the contents with the following:</p>
  <pre class="code">
&lt;h1&gt;DVD Lending Library&lt;/h1&gt;

&lt;table&gt;
   &lt;tr&gt;
     &lt;th class="dvdlib_header"&gt;Title&lt;/th&gt;
     &lt;th class="dvdlib_header"&gt;Status&lt;/th&gt;
   &lt;/tr&gt;
  &lt;% for movie in @movies %&gt;
   &lt;tr&gt;
     &lt;td class="dvdlib_item"&gt;&lt;%=h movie.title %&gt;&lt;/td&gt;
     &lt;td class="dvdlib_item"&gt;In&lt;/td&gt;
     &lt;td&gt;&lt;%= link_to 'Check out', :action =&gt; 'checkout', :id =&gt; movie %&gt;&lt;/td&gt;
     &lt;td&gt;&lt;%= link_to 'Details', :action =&gt; 'details', :id =&gt; movie %&gt;&lt;/td&gt;
     &lt;td&gt;&lt;%= link_to 'Edit', :action =&gt; 'edit', :id =&gt; movie %&gt;&lt;/td&gt;
     &lt;td&gt;&lt;%= link_to 'Remove', { :action =&gt; 'destroy', :id =&gt; movie },
        :confirm =&gt; 'Are you sure?', :method =&gt; :post %&gt;&lt;/td&gt;
   &lt;/tr&gt;
  &lt;% end %&gt;
&lt;/table&gt;
&lt;%= link_to 'Previous page', { :page =&gt; @movie_pages.current.previous } if @movie_pages.current.previous %&gt;
&lt;%= link_to 'Next page', { :page =&gt; @movie_pages.current.next } if @movie_pages.current.next %&gt;
&lt;br /&gt;
&lt;%= link_to 'Add new movie', :action =&gt; 'new' %&gt;
</pre>

  <p>We also need to create a form to add movies. The <code>&lt;%=
  link_to 'Add new movie', :action =&gt; 'new' %&gt;</code> uses
  <em>new.rhtml</em> which in turn calls <em>_form.rhtml</em>. Open
  <em>_form.rhtml</em> (app/views/library/_form.rhtml) and replace
  the contents with the following:</p>
  <pre class="code">
&lt;%= error_messages_for 'movie' %&gt;
&lt;!--[form:movie]--&gt;
&lt;p&gt;&lt;label for="movie_title"&gt;Title&lt;/label&gt;&lt;br/&gt;
&lt;%= text_field 'movie', 'title'  %&gt;&lt;/p&gt;

&lt;p&gt;&lt;label for="movie_created_on"&gt;Added to library on:&lt;/label&gt;&lt;br/&gt;
&lt;%= date_select 'movie', 'created_on'  %&gt;&lt;/p&gt;
&lt;!--[eoform:movie]--&gt;
</pre>

  <p>We've created an editable field for entering the movie title,
  and shown the current date stamp as the creation time.</p>

  <p>Go ahead and add a few of your favourite movies. The "Check
  out" and "Details" links won't do anything yet, but you can Add,
  Edit, or Remove titles.</p>

  <h2><a name="rails_edit_title" id="rails_edit_title">Editing a
  Title in Place</a></h2>

  <p>Rails has some built in JavaScript methods that provide some
  useful functionality. We could use one of these to make the Title
  field in our main library/list view editable.</p>

  <p>Open <em>list.rhtml</em> (apps/views/library/list.rhtml) and
  replace the <code>&lt;td class="dvdlib_item"&gt;&lt;%=h
  movie.title %&gt;&lt;/td&gt;</code> line with the following:</p>
  <pre class="code">
    &lt;td class="dvdlib_item"&gt;
      &lt;% @movie = movie %&gt;
      &lt;%= in_place_editor_field  :movie, :title %&gt;
     &lt;/td&gt;
</pre>

  <p>The <code>in_place_editor_field</code> requires an instance
  name, so we need to assign the current value to
  <code>@movie</code>. If you type this in instead of pasting,
  you'll notice autocompletion for the
  <code>in_place_editor_field</code> method.</p>

  <p>Next, open <em>library.rhtml</em>
  (apps/views/layouts/library.rhtml). Add the following line in the
  <code>&lt;head&gt;</code> section:</p>
  <pre class="code">
   &lt;%= javascript_include_tag :defaults %&gt;
</pre>

  <p>This line includes the default Rails JavaScript libraries
  (<code>&lt;script src="/javascripts/...</code>) in the library
  page allowing the title to be edited in place. Since the 'Edit'
  link is now redundant, feel free to remove this line from
  <em>list.rhtml</em>:</p>
  <pre style="background-color:#E9E9E9; display:inline">
    &lt;td&gt;&lt;%= link_to 'Edit', :action =&gt; 'edit', :id =&gt; movie %&gt;&lt;/td&gt;
</pre>

  <p>The field in the page is now editable, but the change is not
  savable until we make a change in <em>library_controller.rb</em>
  (app/controllers/library_controller.rb). Add the following on
  line 2, just below the LibraryController class declaration.</p>
  <pre class="code">
    in_place_edit_for :movie, :title
</pre><br />

  <table align="center" width="60%">
    <tbody>
      <tr>
        <td class="startupBox">
          <p><strong>Komodo Tip</strong>: Komodo has some useful
          tools for debugging AJAX calls. Check out the <a href=
          "../http-insp.html">HTTP Inspector</a> and
          <a href="../debugjs.html">JavaScript
          Debugger</a>.</p>
        </td>
      </tr>
    </tbody>
  </table>

  <h2><a name="rails_check_out" id="rails_check_out">Check Out a
  Movie</a></h2>

  <p>On the main library list page, each movie has four actions
  associated with it: "Check out", "Details", and "Remove".
  "Remove" (and the "Edit" action that we just removed) is a
  generic web/database function that Rails provides which works
  well enough for our library application. "Check out" and
  "Details" are specific to our application and will have to be
  defined in our Controller (<em>library_controller.rb</em>).</p>

  <p>Our check out function should do the following:</p>

  <ul>
    <li>Redirect to a form</li>

    <li>Ask for the borrower's name</li>

    <li style="list-style: none">
      <ul>
        <li>if the name is in the database, accept</li>

        <li>if not, prompt the user to enter a new name</li>
      </ul>
    </li>

    <li>Link the borrower to the movie in the database</li>

    <li>Redirect back to the main list</li>
  </ul>

  <p>Here are the routines we need to add to
  <em>library_controller.rb</em>. Put them at the bottom of the
  file, just before the last <code>end</code>.</p>
  <pre class="code">
  def checkout
    @movie = Movie.find(params[:id])
  end

  def do_checkout
    movie_id = params[:id]
    name = params[:person][:name]
    if name.blank?
      flash[:notice] = 'No name given'
      redirect_to :action =&gt; :checkout, :id =&gt; movie_id
    elsif (@name = Person.find_by_name(name)).blank?
      flash[:notice] = "Who is #{name}?"
      redirect_to :action =&gt; checkout, :id =&gt; movie_id
    else
      @movie = Movie.find(movie_id)
      checkout = Checkout.create(:movie_id =&gt; movie_id,
                                 :person_id =&gt; @name.id).save
      redirect_to :action =&gt; :list
    end
  end
  
  def register
    movie_id = params[:id]
    name_to_register = params[:person][:name]
    if name_to_register.blank?
      flash[:notice] = 'No name given'
    else
      person = Person.find_by_name(name_to_register)
      if person
        flash[:notice] = "#{person.name} is already registered"
      else
        Person.create(:name =&gt; name_to_register).save
      end
    end
    redirect_to :action =&gt; :checkout, :id =&gt; movie_id
  end  
</pre>

  <p>Now we need to create the checkout page. Right-click on the
  library folder (app/views/library) and select <strong>Add|New
  File...</strong>. Enter the filename <em>checkout.rhtml</em> and
  click <strong>Open</strong>. Add the following in the new
  file:</p>
  <pre class="code">
&lt;h1&gt;Checkout a movie&lt;/h1&gt;
&lt;p&gt;Title: &lt;%= h @movie.title %&gt;&lt;/p&gt;
&lt;% form_tag :action =&gt; 'do_checkout', :id =&gt; @movie do %&gt;
   &lt;p&gt;Your name: &lt;%= text_field_with_auto_complete(:person, :name) %&gt;
   &lt;%= submit_tag 'Check out' %&gt;
&lt;% end %&gt;

&lt;h2&gt;Please register me&lt;/h2&gt;
&lt;% form_tag :action =&gt; 'register', :id =&gt; @movie do %&gt;
   &lt;p&gt;&lt;label for="movie_title"&gt;Your name&lt;/label&gt;&lt;br/&gt;
     &lt;%= text_field 'person', 'name'  %&gt;&lt;/p&gt;
   &lt;%= submit_tag 'Add me' %&gt;
&lt;% end %&gt;

&lt;%= link_to 'Back to the library', :action =&gt; 'list' %&gt;
</pre>

  <p>Notice the <code>text_field_with_auto_complete(:person,
  :name)</code>. This should give us autocompletion in the browser
  based on people we've added to the library database. Currently
  (even after adding a few people to the database) this won't
  happen. In fact, the log output in the Webrick window shows
  "<code>ActionController::UnknownAction (No action responded to
  auto_complete_for_person_name)</code>". As with the
  <code>in_place_editor_field</code> in <em>list.rhtml</em>, we
  need to add something to our LibraryController class. Insert the
  following into <em>library_controller.rb</em> at line 3:</p>
  <pre class="code">
    auto_complete_for :person, :name
</pre>

  <p>The field should now give autocompletion options when you
  start typing a name into it.</p>

  <p>To change the main library list page to show whether a movie
  is "In" or "Out". In <em>list.rhtml</em>, replace the placeholder
  line '<code>&lt;td class="dvdlib_item"&gt;In&lt;/td&gt;</code>'
  with:</p>
  <pre class="code">
      &lt;% checkout = Checkout.find_by_movie_id(@movie) %&gt;
      &lt;td class="dvdlib_item"&gt;&lt;%= Checkout.find_by_movie_id(@movie) ? "Out" : "In" %&gt;&lt;/td&gt;
</pre>

  <h2><a name="rails_debug" id="rails_debug">Debugging Rails</a>
  <span class="version_alert">Komodo IDE only</span></h2>

  <p>There is a bug in the <code>do_checkout</code> function that
  can be triggered by entering new (i.e. not registered) name in
  the 'Checkout a movie' section of <em>checkout.rhtml</em>.
  Entering a new name in the 'Your name' field section generates a
  'No action responded to <em>number</em>' error. It should instead
  give us a message saying "Who is <em>name</em>?" We can use
  Komodo's <a href="../debugger.html">debugger</a> to
  try to find the problem.</p>

  <table align="center" width="60%">
    <tbody>
      <tr>
        <td class="startupBox">
          <p><strong>Komodo Tip</strong>: The <a
          href="../debugruby.html">Debugging Ruby documentation</a>
          has information on configuring Komodo for <a
          href="../debugruby.html#Configure_Ruby_Debugger">local</a>
          and <a
          href="../debugruby.html#Ruby_Remote_Debugger">remote</a>
          Ruby debugging. If the steps below do not work automatically, check
          the configuration and settings described in the documentation or
          consult the <a target="_blank"
          href="http://community.activestate.com/faq-list">online FAQs</a>.</p>
        </td>
      </tr>
    </tbody>
  </table>

  <p>Open <em>library_controller.rb</em> in an editor tab. Set a
  breakpoint on the '<code>flash[:notice] = "Who is
  #{name}?"</code>' line by clicking in the blank margin to the
  left. An orange octagonal icon should appear indicating the
  breakpoint.</p>

  <ol>
    <li>Stop the WEBrick server by entering 'Ctrl'+ 'C' in the
    terminal window running the server.</li>

    <li>Start the debugging version of the server by
    double-clicking the <strong>debug rails app</strong> macro. By
    default, the debugger will stop on the first line of executable
    code, in this case line 2 of <em>script/server</em>.</li>

    <li>Click <strong>Go/Continue</strong> in the Debug menu ('F5')
    or the <strong>Go/Continue</strong> button in the toolbar.</li>

    <li>In your browser, navigate to <a target="_blank" href=
    "http://localhost:3000/library/checkout/1">http://localhost:3000/library/checkout/1</a>
    (or the checkout page for the movie of your choice).</li>

    <li>Enter a new name in the 'Your name' field of the 'Checkout
    a movie' section (one that is not already in your
    database).</li>
  </ol>

  <p>The <em>library_controller.rb</em> tab should come to the
  foreground in Komodo, with a yellow arrow over the breakpoint we
  set earlier. While execution of the application is paused, we can
  examine variables and interact with the application via the Ruby
  shell. On the <strong>Locals</strong> tab on the left side of the
  bottom pane, we can see the following variables from the
  <code>do_checkout</code> function:</p>

  <table summary="Local Variables" border="1" cellspacing="0"
  cellpadding="3" width="50%" style="margin-left: 3em">
    <tbody>
      <tr>
        <td><strong>Name</strong></td>

        <td><strong>Type</strong></td>

        <td><strong>Value</strong></td>
      </tr>

      <tr>
        <td>checkout</td>

        <td>null</td>

        <td>&nbsp;</td>
      </tr>

      <tr>
        <td>movie_id</td>

        <td>string</td>

        <td>1</td>
      </tr>

      <tr>
        <td>name</td>

        <td>string</td>

        <td><em>NewName</em></td>
      </tr>
    </tbody>
  </table>

  <p>The <code>movie_id</code> and <code>name</code> variables are
  as expected, but where does this <code>checkout</code> variable
  come from?</p>

  <p>The line immediately below our breakpoint has the
  following:</p>
  <pre class="code">
      redirect_to :action =&gt; checkout, :id =&gt; movie_id
</pre>

  <p>The <code>:action</code> is <code>checkout</code> (an
  undefined variable) rather than <code>:checkout</code> (a symbol
  for the <code>checkout</code> function). Add the colon and the
  checkout page should work as expected.</p>

  <p>You can now leave WEBrick in debugging mode, or shut it down
  ('Ctrl'+'C' in the console) and restart it with the <strong>run
  server</strong> macro.</p>

  <h2><a name="rails_return_movie" id=
  "rails_return_movie">Returning a movie</a></h2>

  <p>Now that we can check out a movie, we should add the ability
  to return it. Currently we have a 'Check out' link. We can change
  this so that it shows 'Check out' if the movie is in, and
  'Return' if the movie is out. Replace the entire <em>second</em>
  <code>&lt;tr&gt;</code> section in <em>list.rhtml</em> with the
  following:</p>
  <pre class="code">
  &lt;tr&gt;
    &lt;td class="dvdlib_item"&gt;
      &lt;% @movie = movie %&gt;
      &lt;%= in_place_editor_field  :movie, :title %&gt;
    &lt;/td&gt;
    &lt;% checkout = Checkout.find_by_movie_id(@movie) %&gt;
    &lt;td class="dvdlib_item"&gt;&lt;%= checkout ? "Out" : "In" %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;% if checkout %&gt;
        &lt;%= link_to 'Return', :action =&gt; 'return', :id =&gt; movie %&gt;
        &lt;% else %&gt;
        &lt;%= link_to 'Check out', :action =&gt; 'checkout', :id =&gt; movie %&gt;
        &lt;% end %&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;%= link_to 'Details', :action =&gt; 'details', :id =&gt; movie %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to 'Remove', { :action =&gt; 'destroy', :id =&gt; movie }, :confirm =&gt; 'Are you sure?', :method =&gt; :post %&gt;&lt;/td&gt;
   &lt;/tr&gt;
</pre>

  <p>Here is the method we need to add to
  <em>library_controller.rb</em>:</p>
  <pre class="code">
  def return
    movie_id = params[:id]
    checkout = Checkout.find_by_movie_id(movie_id)
    if checkout
      Checkout.delete(checkout)
    end
    redirect_to :action =&gt; :list
  end
</pre>

  <h2><a name="rails_checkout_details" id=
  "rails_checkout_details">Viewing Checkout Details</a></h2>

  <p>The application is now mostly working. There's just one
  crucial component left to implement. The 'Details' link currently
  doesn't do anything (besides bringing up an "Unknown action"
  error). We want this page to show us who has the movie, and when
  it was checked out.</p>

  <p>Right-click on the library folder (app/views/library) and
  select <strong>Add|New File...</strong>. Enter the filename
  <em>details.rhtml</em> and click <strong>Open</strong>. Add the
  following in the new file:</p>
  <pre class="code">
&lt;h1&gt;Checkout details&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Movie: &lt;%= h @movie.title %&gt;&lt;/li&gt;
  &lt;li&gt;Borrower: &lt;%= h(@person.name) %&gt;&lt;/li&gt;
  &lt;li&gt;Borrowed: &lt;%= @checkout_date %&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/p&gt;

&lt;%= link_to 'Return', :action =&gt; 'return', :id =&gt; @movie %&gt;
&lt;%= link_to 'List', :action =&gt; 'list' %&gt;
</pre>

  <p>Of course, we'll need another method in
  <em>library_controller.rb</em>:</p>
  <pre class="code">
  def details
    movie_id = params[:id]
    @movie = Movie.find(movie_id)
    checkout_id = params[:checkout]
    checkout = Checkout.find(checkout_id)
    if !checkout
      redirect_to :action =&gt; :list
    else
      @person = Person.find(checkout.person_id)
      @checkout_date = checkout.created_on
    end
  end
</pre>

  <p>Lastly, we must pass a checkout id as a parameter when the
  page is called, because we're viewing the checkout details as
  well as the movie details. Modify the '<code>link_to
  'Details'</code> line in <em>list.rhtml</em> to include the
  following:</p>
  <pre class="code">
    &lt;td&gt;&lt;% if checkout %&gt;
      &lt;%= link_to 'Details', :action =&gt; 'details', :id =&gt; movie, :checkout =&gt; checkout %&gt;
      &lt;% end %&gt;
    &lt;/td&gt;
</pre>

  <p>Not only does this pass the <code>checkout_id</code>
  parameter, it hides the 'Details' link if the movie is not
  checked out.</p>

  <h2><a name="rails_resources" id="rails_resources">Rails
  Resources</a></h2>

  <h3>Tutorials and Reference Sites</h3>

  <ul>
    <li><a target="_blank" href="http://www.rubyonrails.org/">Ruby
    on Rails</a>: The home page of the Ruby on Rails project. Links
    to downloads, documentation and other resources.</li>

    <li><a target="_blank" href=
    "http://www.onlamp.com/pub/a/onlamp/2006/12/14/revisiting-ruby-on-rails-revisited.html">
    Rolling with Ruby on Rails (Revisited)</a>: A Windows-based
    tutorial by Bill Walton and Curt Hibbs.</li>

    <li><a target="_blank" href=
    "http://instantrails.rubyforge.org/wiki/wiki.pl">Instant
    Rails</a>: An all-in-one bundle for windows containing Ruby,
    Rails, Apache, and MySQL.</li>

    <li><a target="_blank" href=
    "http://www.softwaredeveloper.com/features/74-ruby-on-rails-resources-tutorials-050207/">
    74 Quality Ruby on Rails Resources and Tutorials</a>: An
    excellent compendium of Rails resources.</li>
  </ul>
  <hr />
</body>
</html>
