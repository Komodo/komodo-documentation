<!-- Copyright (c) 2001-2006 ActiveState Software Inc. -->
<!-- See the file LICENSE.txt for licensing information. -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 1 September 2005), see www.w3.org" />
  <link rel="stylesheet" type="text/css" href="../css/screen.css" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="../favicon.ico" type=
  "image/x-icon" />

  <title>Ruby on Rails Tutorial</title>
</head>

<body>
  <h1><a name="rails_top" id="rails_top">Ruby on Rails
  Tutorial</a></h1>

  <h2><a name="rails_overview" id=
  "rails_overview">Overview</a></h2>

  <h3><a name="rails_prerequisites" id="rails_prerequisites">Before
  You Start</a></h3>

  <p>For this tutorial you will need:</p>

  <ul>
    <li>A recent local installation of <a target="_blank" href=
    "http://www.ruby-lang.org/en/downloads/">Ruby</a> (1.8.5 or
    later).</li>

    <li>A local installation of <a target="_blank" href=
    "http://www.rubyonrails.org/down">Ruby on Rails</a> (version 2.x).</li>

    <li>Access to a <a target="_blank" href=
    "http://mysql.org/downloads/">MySQL</a> or
    <a target="_blank" href="http://www.sqlite.org/">SQLite</a>
    database.</li>
  </ul>

  <p>Several online "how to" guides are available for installing
  and configuring Ruby on Rails. See <a href=
  "#rails_resources">Rails Resources</a> for links to setup
  tutorials and installation bundles</p>

  <h3><a name="rails_scenario" id="rails_scenario">Tutorial
  Scenario</a></h3>

  <p>This tutorial walks you through the creation of a very simple
  Rails application. The Movie Lending Library application is a web
  application that allows you to add, remove, borrow and return
  movies from a shared library.</p>

  <p>Komodo has a very powerful Ruby on Rails project template with
  macros and commands for further automating the creation of Rails
  applications. The entire application can be created within Komodo
  using these tools and Komodo itself, without having to work at
  the command-line.</p>

  <p>In this tutorial you will:</p>

  <ol>
    <li>Create a new Rails scaffold using the Ruby on Rails Komodo
    project template.</li>

    <li>Create a MySQL database.</li>

    <li>Create the core of the application using just the project
    macros.</li>

    <li>Write some code to iteratively develop the Movie Library
    application.</li>

    <li>Test and debug the application.</li>
  </ol>

  <h2><a name="rails_template_new" id="rails_template_new">Creating
  a Rails Project</a></h2>

  <p>Komodo ships with a powerful template for Rails projects,
  containing several macros for:</p>

  <ul>
    <li>Creating and deleting databases</li>

    <li>Generating controllers, migrations, models and
    scaffolds</li>

    <li>Migrating databases</li>

    <li>Running a built-in web server(<a target="_blank"
    href="http://mongrel.rubyforge.org/">Mongrel</a>, <a target="_blank"
    href="http://www.webrick.org/">Webrick</a>, or <a target="_blank"
    href="http://www.lighttpd.net/">LightHTTPD</a>)</li>

    <li>Debugging the application</li>
  </ul>

  <p>To create the tutorial project file:</p>

  <ol>
    <li>Make a new directory/folder in a convenient location (e.g.
    C:\rails on Windows, or /home/<em>username</em>/rails on OS X
    or Linux).</li>

    <li>In Komodo, select <strong>File|New|New Project from
    Template</strong>.</li>

    <li>In the New Project dialog box, select the <strong>Ruby on
    Rails</strong> template from the Common category.</li>

    <li>Give the file a useful name. Since this tutorial creates a
    movie lending library, let's call it
    <em>movielib.kpf</em>.</li>

    <li>Specify your working directory (the one created in the
    first step) in the <strong>Directory</strong> field. Use the
    <strong>Browse</strong> button to find it if you wish.</li>

    <li>Click <strong>Open</strong>.</li>
    
    <li>Komodo will give you a choice of databases to use.  The Rails
    project has tools that automate creating and deleting databases, but
    they currently work only with MySQL.  This step isn't needed for
    SQLite, so if you choose PostgreSQL or Oracle, you'll need to build
    your databases outside Komodo using either the command-line or another
    application.  This covers the DDL (Data Definition Language)
    part of database manipulation; Rails handles all data manipulation.</li>
  </ol>

  <p>If Rails has been installed correctly, you should see output in the
  bottom pane saying "The movielib project is built".  The
  movielib.kpf project should open in the <strong>Projects</strong>
  tab on the left, and should contain "<a href=
  "../folders.html">Live Folders</a>" of all the
  directories created by the <code>rails</code> command (app,
  components, config, db, etc.) plus a Virtual Folder containing
  the Komodo macros we'll be using.</p>

  <table align="center" width="60%">
    <tbody>
      <tr>
        <td class="startupBox">
          <p><strong>Komodo Tip</strong>: Komodo project templates
          can have a special macro called <code>oncreate</code>
          which run when a new project is created from the
          template. The <code>oncreate</code> macro in this Ruby on
          Rails template runs the command '<code>rails .
          --skip</code>' in the current working directory to
          create the project.</p>
        </td>
      </tr>
    </tbody>
  </table>

  <p>Rails tools have a lot of third-party dependencies, and sometimes a new
  release of one of them can break the tools in the Rails project template. If
  a macro or command isn't working as expected, check the the <a target="_blank"
  href="http://community.activestate.com/faq-list">online FAQs</a> for possible
  solutions.</p>
  
  <h2><a name="rails_create_db" id="rails_create_db">Creating the
  Database</a></h2>

  <h3><a name="rails_edit_database_yml" id=
  "rails_edit_database_yml">Editing the database.yml file</a></h3>
  
  <p>If you chose SQLite2 or SQLite3 as your database tool, you can skip
  this step.  If you chose postgresql or oracle, you'll need to manage
  the database manually.  So this section applies only to MySQL users.</p>

  <p>If MySQL is installed locally and can accept connections by
  'root' without a password (it often is by default), click the
  <strong>Create Databases</strong> macro in the <strong>Rails
  Tools</strong> project folder to create the database.</p>

  <p>If you have set a MySQL root password, created another MySQL
  account that you would like to use, or are running the server on
  a different host, you will need to configure the
  <em>database.yml</em> file:</p>

  <ol>
    <li>Open the <strong>config</strong> project folder and double-click
    <em>database.yml</em> to open it in an editor tab.</li>

    <li>As necessary, modify the <code>username</code> and
    <code>password</code> values to match the configuration of your
    MySQL server. If you're not sure what values to use, leave the
    default values ('<code>username: root</code>' and
    '<code>password:</code> '). In this tutorial, we will only be
    working with the <code>development</code> database, but you
    should modify the <code>test</code> and <code>production</code>
    sections as well to avoid errors with the <strong>Create
    Databases</strong> macro below.</li>

    <li>If you are running MySQL on a remote server, add the
    setting <code>hostname:</code> <em>host</em> to the
    <code>development:</code> configuration block, or modify the
    value if that setting is already present (set to
    <code>localhost</code> by default.</li>
  </ol>

  <p>If you would like to use a database server other than MySQL,
  consult the <a target="_blank" href=
  "http://www.rubyonrails.org/docs">Rails documentation</a> on
  configuring this file, making sure you have the necessary
  <a target="_blank" href=
  "http://wiki.rubyonrails.com/rails/pages/DatabaseDrivers">database
  drivers</a> installed, and creating the database manually. The
  database macros in the project will only work with MySQL.</p>

  <h3><a name="rails_create_databases_macro" id=
  "rails_create_databases_macro">Running the Create Databases
  Macro</a></h3>

  <p>In the Rails Tools project folder is a macro called
  <strong>Create Databases</strong>. Double-click the macro to run
  it.</p>

  <p>If the <em>database.yml</em> file (and the database server)
  are configured correctly, a database called
  <strong>movielib</strong> (as specified in the
  <em>database.yml</em> file - derived from the project name) will
  be created and an alert will appear indicating that the database
  creation is done.</p>

  <h2><a name="rails_generate_scaffold" id=
  "rails_generate_scaffold">Creating a Scaffold</a></h2>

  <p>Generating a scaffold is a quick way to get a skeletal,
  working Rails application that can be modified iteratively. Since
  most database driven web applications are very similar in their
  basic design, Rails builds a generic application based on the
  information in your models which you can then modify to meet your
  specific requirements.</p>

  <p>In the Generators folder, double-click the
  <strong>scaffold</strong> macro. In the dialog box enter
  <code>movie</code> as the model name, and <code>title:string</code> as
  the only attribute in the <code>movie</code> model. Click <strong>OK</strong>.</p>

  <p>The following output should appear in the <strong>Command
  Output</strong> tab showing the files created in this step:</p>
  <pre class="code">
      exists  app/models/
      exists  app/controllers/
      exists  app/helpers/
      create  app/views/movies
      exists  app/views/layouts/
      exists  test/functional/
      exists  test/unit/
      create  app/views/movies/index.html.erb
      create  app/views/movies/show.html.erb
      create  app/views/movies/new.html.erb
      create  app/views/movies/edit.html.erb
      create  app/views/layouts/movies.html.erb
      create  public/stylesheets/scaffold.css
  dependency  model
      exists    app/models/
      exists    test/unit/
      exists    test/fixtures/
      create    app/models/movie.rb
      create    test/unit/movie_test.rb
      create    test/fixtures/movies.yml
      create    db/migrate
      create    db/migrate/001_create_movies.rb
      create  app/controllers/movies_controller.rb
      create  test/functional/movies_controller_test.rb
      create  app/helpers/movies_helper.rb
       route  map.resources :movies
</pre>

  <p>Several files are created and opened in editor tabs.  You can unclutter
  your workspace by closing most of them.  For now keep the files
  but <em>movie.rb</em>, <em>movie_tests.rb</em>, <em>movie_controller.rb</em>,
  and <em>movie_controller_tests.rb</em>.
  We'll return to most of the other generated files later.</p>

  <h3><a name="rails_migration" id=
  "rails_migration">Migration</a></h3>

  <p>Now that we've defined the model in Rails, we need to apply
  them to our database. In Rails this is done with the '<code>rake
  db:migrate</code>' command. Again, there's a macro to do this for
  us.</p>

  <p>Double-click the <strong>db:migrate</strong> macro in Rails
  Tools|Migrate. The <strong>Command Output</strong> tab should show that the table
  'movies' has been created.</p>
  
  <h2><a name="rails_testing_basics" id="rails_testing_basics"
  >Testing Rails Scaffolds</a></h2>
  
  <p>At this point we have a working application.  While it's tempting
  to start the server, switch to the browser, and try it out, we
  should take advantage of the testing framework built into Rails to
  verify that our application is working as we expect.</p>
  
  <p>Let's add a couple of sanity checks to the model: we want to verify
  that all movie entries have a title, and that there are no duplicates.  Bring
  up <em>movie.rb</em> and add this code at lines 2 and 3, immediately after
  <code>class Movie &lt; ActiveRecord::Base</code>:</p>
  
  <pre class="code">
   validates_presence_of :title
   validates_uniqueness_of :title
  </pre>
  
  <p>You should see code-completion after you type <code>val</code> each time.
  </p>
  
  <p>In the second line, after you type <code>:t</code> you can press
  the tab key to have it finish <code>:title</code>.  If this does nothing
  verify that the "Use tab character to complete words like Ctrl+Space"
  setting is on under <strong>Edit|Preferences|Editor|Smart
  Editing</strong>.</p>
  
  <p>Bring up <em>movie_test.rb</em>, delete the <code>test_truth</code>
  that the scaffolder generated for you, and add these two tests:</p>
  
  <pre class="code">
 def test_present
   m = Movie.new
   assert !m.valid?
   m.title = "Rocky"
   assert m.valid?
 end

 def test_unique
   m1 = Movie.create(:title =&gt; "Alien")
   assert m1.valid?
   m2 = Movie.create(:title =&gt; "Alien")
   # First film should still be valid
   assert m1.valid?
   assert !m2.valid?
   m2.title += "s"
   assert m2.valid?
 end
  </pre>
  
  <h3><a name="running_tests_in_komodo_ide" id="running_tests_in_komodo_ide">
  Running Model Tests in Komodo IDE</a></h3>
  
  <p>Komodo IDE introduced unit-test integration with version 4.3. To
  run the unit tests click on the <strong>Test Results</strong> tab in
  the bottom window. In the test plan dropdown menu on the right side.
  Select "test:units", and press the <strong>Run</strong> button
  immediately to the right.</p>
  
  <p>You should see the tests run for a few seconds, and then a list of
  results will appear. If you get a message along the lines of the
  following: "Run `rake db:migrate` to update your database then try
  again." you probably skipped that step above. Run the <strong>Rails
  Tools|Migrate|db:migrate</strong> command, and retry the tests.</p>

  <p>The result tab should show that 2 tests passed, 0 failed, and
  there were 0 errors.  There's also an "Information" line,
  where Komodo displays lines of output from the underlying test
  pass that might be of interest, but don't fit in any particular
  test.</p>
  
  <h3><a name="running_tests_in_komodo_edit" id="running_tests_in_komodo_edit">
  Running Tests in Komodo Edit</a></h3>
  
  <p>This tutorial assumes you're using Komodo IDE, but it's easy to
  follow along with Komodo Edit. You can run unit tests inside Komodo
  Edit with the <strong>Rails Tools|Test|Unit Tests</strong> command.
  This will show the results in the Command Output window. You should
  see a final result of:</p>
  
  <pre>
    2 tests, 6 assertions, 0 failures, 0 errors
  </pre>
  
  <p>Other commands (e.g. <code>rake test:functionals</code> below) can
  be run in a <a href="../run.html">Run Command</a>.</p>

  <h3><a name="running_controller_tests">Running Controller Tests</a></h3>
  
  <p>While the generated model test file has one trivial test, the Rails
  scaffolder generates a full complement of controller tests. Bring up
  <em>movie_controller_test.rb</em> to have a look at them.</p>
  
  <p>Click on the <strong>Test Results</strong> tab, select the
  <strong>test:functionals</strong> test from the dropdown list, and
  press the <strong>Run</strong> button.</p>
  
  <p>This time you should see that two of the tests failed:
  <code>test_should_create_movie</code> and
  <code>test_should_update_movie</code>. If you click on the red "failures"
  button above the results, it will cycle through the failed tests.</p>
  
  <p>The <strong>Details</strong> window shows the results for each test.  Make sure
  the <code>test_should_create_movie</code> test is highlighted in the
  first window.</p>
  
  
  <p>Double-click the first line of code that refers to
  <code>test/functional/movies_controller_test.rb</code>.
  <em>movies_controller_test.rb</em> should become the current file,
  with the cursor at the line that was reported in the traceback; in
  this case, line 16. We see that this code is failing:</p>
  
  <pre class="code">
  assert_difference('Movie.count') do
       post :create, :movie =&gt; { }
     end
  </pre>

  <p>The problem is that the controller_test's call to 'post' hits
  the controller's create command, which does go through the
  validation check.  The failure to pass the check prevents a new
  movie from being created, and we still have two entries in the
  database after the block runs.  Let's make a change that should
  satisfy the model's rules:</p>
  
  <pre class="code">
   def test_should_create_movie
     assert_difference('Movie.count') do
       post :create, :movie =&gt; { :title =&gt; "movie 3" }
     end
  </pre>
  
  <p>If we rerun the test, we're now down to one failure. Click on the
  red failure button to move to the failed test, then double-click on
  the line starting with
  <code>test/functional/movies_controller_test.rb:35:in
  `test_should_update_movie'</code> in the <em>Details</em> window to
  see the failed code.</p>

  <pre class="code">
  def test_should_update_movie
    put :update, :id =&gt; movies(:one).id, :movie =&gt; { }
    assert_redirected_to movie_path(assigns(:movie))
  end
  </pre>
  
  <p>It's not obvious why this test is failing. Rails tests are just
  Ruby code, so let's fire up the debugger (Komodo IDE only) to have a
  closer look, with the following steps:</p>
  
  <ul>
    <li>Set a breakpoint
    at line 62 of <em>movies_controller.rb</em>, in the update routine.  </li>
    <li>Bring up <em>movies_controller_test.rb</em></li>
    <li>Start the debugger, with the <code>Debug|Go/Continue</code> menu item</li>
    <li>In the <em>Debugging Options</em> box, make sure the Directory
    field consists of the top-level directory of your project (the
    directory containing the <em>movielib.kpf</em> file, not the test
    file).</li>
    <li>Press OK.</li>
    <li>The debugger should stop at line 62.  Now set breakpoints at lines 64 and
    68, to capture the success and failure branches, and continue.</li>
    <li>The debugger should stop at line 68, since this test failed.  Examine
    the cause of failure by clicking on the <strong>Self</strong> tab in the
    <strong>Debug: movies_controller.rb</strong>
    tab, finding <code>@movie</code>, and then expanding the <code>.@errors</code>
    field under it.  This
    field has another <code>.@errors</code> field, so expand that, and you'll see that the
    <code>title</code> field is set to <code>"has already been taken"</code>.  Why?</li>
  </ul>
  
  <p>What are those duplicate values?  While the debugger is still running,
  enter the interactive shell with the <strong>Debug|Interact</strong> menu command,
  and type the line:</p>
  
  <pre>
    Movie.find(:all).map(&amp;:title)
  </pre>
  
  <p>Ruby should reply with <code>["MyString", "MyString"]</code>.  Those values
  come from the file <em>test/fixtures/movies.yml</em>.  The problem
  is that when Rails reads the fixtures file to populate the database, it doesn't
  run the values through ActiveRecord's validation checks. Once you
  start using controller methods, like the <code>update</code> method
  here, the values are run through validation checks.</p>
  
  <p>Let's fix that. Stop the debugger and change one of those
  "MyString" movie titles to something more interesting, like "Who Is
  Harry Kellerman and Why Is He Saying Those Terrible Things About Me?",
  or "My Other String", if you're not up for all that typing.</p>
  
  <p>The unit and functional tests should now pass.</p>


  <h2><a name="rails_starting_app" id=
  "rails_starting_app">Starting the Rails Application Server</a></h2>

  <p>At this point we have a working application. It's not yet
  useful as a lending library, but we can have a look at what we've
  got so far.</p>

  <p>In the Run folder, double-click the <strong>run
  server</strong> macro. This will start one of the <strong>Mongrel</strong>,
  <strong>lighttpd</strong>, or <strong>Webrick</strong> servers, depending
  on your Ruby installation, and run it in a separate console window.</p>
  
  <h3><a name="mongrel_issues" id="mongrel_issues">Dealing with Mongrel</a></h3>
  
  <p>Rails now uses Mongrel as its default web server.  The dependencies between
  different versions of Mongrel, Mongrel_Service and Rails haven't been worked out
  on Windows yet.  If your console window exits with a <code>MissingSourceFile</code>
  message (along with a long traceback), you can have Rails use Webrick by editing
  the <strong>Rails Tools|Run|run server</strong> macro (right-click ->
  Properties) and making the following change:</p>
  
  <p>Replace the line:</p>
  
    <pre class="code">
       as_rails_macros.launchRubyAppInConsole(this, project, 'script/server');
    </pre>
  <p>with:</p>
    <pre class="code">
       as_rails_macros.launchRubyAppInConsole(this, project, 'script/server webrick');
    </pre>
  
    
  <h3><a name="testing_app_1" id="testing_app_1">Testing the Application</a></h3>

  <p>Open the <a target="_blank" href=
  "http://localhost:3000/movies">http://localhost:3000/movies</a>
  in your favorite web browser. You should see a <strong>Listing movies</strong>
  page with no data and a <strong>New movie</strong> link. This is now
  usable, but not terribly interesting.  However we can leave the web server running and see our
  changes as we make them.</p>

  <p>While the application the Rails scaffolder generates is certainly
  serviceable, there are some tweaks that will immediately make it
  friendlier:</p>
  
  <p>If we're going to enter a number of movies, let's speed things
  up by stealing the <strong>New Movie</strong> link
  from <em>index.html.erb</em>, and placing it in <em>show.html.erb</em>:</p>
  
  <p>Copy the line</p>
  <pre class="code">
  &lt;%= link_to 'New movie', new_movie_path %>
  </pre>
  
  <p>from <em>index.html.erb</em>, and paste it at the end of
  <em>show.html.erb</em>.  Put a "|" character at the end of
  the previous line to maintain consistency.  Save
  <em>show.html.erb</em>.  No need to restart the server -- switch
  to the app, enter a new title at the <strong>New Movie</strong> screen,
  press the "Create" button, and you should have a
  "New movie" link.</p>
  
  <p>Similarly, it would be nice if the cursor was in the
  <strong>Title</strong> field when we load the <strong>New movie</strong> page,
  similar to how the <strong>Search</strong> field has the focus on
  Google's home page.   Since we're going to be using
  the <strong>Prototype</strong> library, I added the
  <code>javascript_include_tag</code> directive to the head section of
  <em>app/views/layouts/movies.html.erb</em>:</p>
  
  <pre class="code">
    &lt;title>Movies: &lt;%= controller.action_name %>&lt;/title>
    &lt;%= stylesheet_link_tag 'scaffold' %>
    &lt;%= javascript_include_tag :defaults %>
  </pre>
  
  <p>Then add this code to the end of <em>new.html.erb</em>:</p>
  
  <pre class="code">
  &lt;script type="text/javascript">
  Event.observe(window, "load", function() {
      $('movie_title').focus();
      });
  &lt;/script>
  </pre>
  
  <p>If you type this code in, you should see code-completion after
  '<code>Event.</code>' and a call-tip after '<code>(</code>' if you've
  enabled the <em>prototype.js</em> code intelligence <a
  href="../prefs.html#code_intel">API catalog</a> in <a
  href="../prefs.html">Preferences</a>.</p>

  <p>Again, there's no need to restart the server.  As soon as you load
  the new controller and view code, your changes will come into
  effect.</p>

  <h2><a name="installing_plugins" id="installing_plugins">Installing Plugins</a></h2>

  <p>Too many software packages gain bloat as they reach higher revisions.
  Rails is different -- the Rails team actually dropped much of its code
  going from 1.2 to 2.0.  Most the dropped functionality is still
  available as plugins,  but now people who want it need to explicitly
  install it.  The idea is that people who don't need a particular
  widget shouldn't subsidize the few who want it.</p>
  
  <p>We're going to install two plugins, to handle in-place editing and
  pagination.</p>
  
  <p>Fortunately Komodo ships with macros that install these plugins,
  and add necessary patches. Open the <code>Rails Tools|Plugins</code>
  folder in your Rails project, and run the <code>in-place
  editing</code> and <code>pagination</code> macros. If you try to
  install a plugin that's already installed, you'll get a warning.</p>
  
  <p>It's easy to create new plugin macros.  Every installable plugin is
  treated as a resource, usually in a public subversion repository,
  and identifiable with a URI.  On the command-line you would invoke
  <code>ruby script/install plugin &lt;URI&gt;</code>.  In Komodo you would
  just need to copy one of the macros, paste it into the same Plugins
  folder, edit it, and replace the old URI with the new one.</p>
  
  <p>Plugins need to be installed in new Rails projects that use them
  (i.e. the plugin is added to the specific Rails application, not to
  Rails itself). You have to restart the server after doing this, so
  this would be a good time to stop the current Rails server. Find the
  window it's running in, and press <code>Ctrl-C</code>
  (<code>Ctrl-Break</code> on Windows). We'll restart it again later.</p>

  <h3><a name="adding_pagination" id="adding_pagination">Adding
  Pagination</a></h3>
  
  <p>First we'll add pagination by making these changes to the
  <strong>movie</strong> model and controller.</p>
  
  <p>In <em>app/controllers/movies_controller.rb</em>, change line 5 from:</p>

  <pre class="code">
     @movies = Movie.find(:all)
  </pre>  
  
  <p>to</p>
  
  <pre class="code">
     @movies = Movie.paginate(:page =&gt; params[:page])
  </pre>
  
  <p>Add this code at the class level to <em>app/models/movie.rb</em> (lines 4-5):</p>
  
  <pre class="code">
     cattr_reader :per_page
     @@per_page = 10
  </pre>
  
  <p>Finally, add pagination to the view.  The last three lines
  of <em>app/views/movies/index.html.erb</em> should contain this code:</p>
  
  <pre class="code">
  &lt;%= will_paginate(@movies) %&gt;
  &lt;br /&gt;
  &lt;%= link_to 'New movie', new_movie_path %&gt;
  </pre>

  <h3><a name="testing_pagination" id="testing_pagination">Testing
  Pagination</a></h3>
  
  Now we could start up the server, enter a few dozen
  <em>different</em> titles, and verify that the pagination
  is working.  Or we can write another test, in
  <em>movies_controller_test.rb</em>:

  <pre class="code">
  def test_pagination
    Movie.delete_all
    35.times {|i| Movie.create(:title =&gt; "title #{i}")}
    get :index
    assert_tag(:tag =&gt; 'div',
               :attributes =&gt; { :class =&gt; 'pagination'})
    assert_tag(:tag =&gt; 'span',
               :content =&gt; '&amp;laquo; Previous',
               :attributes =&gt; { :class =&gt; 'disabled'})
    assert_tag(:tag =&gt; 'span',
               :content =&gt; '1',
               :attributes =&gt; { :class =&gt; 'current'})
    assert_tag(:tag =&gt; 'div',
               :attributes =&gt; { :class =&gt; 'pagination'},
               :child =&gt; { :tag =&gt; 'a',
                 :attributes =&gt; { :href =&gt; "/movies?page=4" },
                 :content =&gt; "4" })
  end
  </pre>
  
  <p>Those <code>assert_tag</code> tests might look like they were pulled out
  of thin air, but the debugger was very useful in writing them.  Originally
  the test read like this:</p>
  
  <pre class="code">
  def test_pagination
    Movie.delete_all
    35.times {|i| Movie.create(:title =&gt; "title #{i}")}
    get :index
    assert_response :success
  end
  </pre>
  
  <p>We used the debugger to stop at the final line, captured the contents
  of <code>@request.body</code> by double-clicking on it in the <strong>Self</strong> tab
  of the <strong>Debug</strong> tab, and pasted it into an empty <code>HTML</code> buffer
  in Komodo, and found the paginator was generating this code:</p>
  
  <pre class="code">
  &lt;div class="pagination"&gt;
      &lt;span class="disabled"&gt;&amp;laquo; Previous&lt;/span&gt;
      &lt;span class="current"&gt;1&lt;/span&gt;
      &lt;a href="/movies?page=2"&gt;2&lt;/a&gt;
      &lt;a href="/movies?page=3"&gt;3&lt;/a&gt;
      &lt;a href="/movies?page=4"&gt;4&lt;/a&gt;
      &lt;a href="/movies?page=2"&gt;Next &amp;raquo;&lt;/a&gt;
  &lt;/div&gt;
  </pre>
  
  <p>We then entered an interactive context with the <code>Debug|Interact</code>
  menu item, found some documentation on the <code>assert_tag</code>, and
  interactively tried out the expressions, starting with simple expressions
  and making them more complex.  A final set that covered the situations
  was then copied into the test.</p>
  
  <h3><a name="using_pagination" id="using_pagination">Testing
  Pagination in the Application</a></h3>
  
  <p>The functional test results should have you convinced that these additions
  didn't break anything.  But now would be a good time to restart the server,
  fire up the app, and make sure it still works as before.  If you add eleven
  movies you should see the paginator at work.</p>
  
  <h3><a name="adding_in_place_editing" id="adding_in_place_editing">Adding
  In-Place Editing</a></h3>
    
  <p>Having to bring up an editing screen to change the
  spelling of a movie is cumbersome.  This is easy to fix.</p>
  
  <p>Add this code to movies/index.html.erb, around line 10:</p>
  
  <pre class="code">
      &lt;td class="dvdlib_item"&gt;
       &lt;% @movie = movie %&gt;
       &lt;%= in_place_editor_field :movie, :title %&gt;
     &lt;/td&gt;
  </pre>
  
  <p>Replace line 3 of <em>show.html.erb</em> with just this line:</p>
  
  <pre class="code">
      &lt;%= in_place_editor_field :movie, :title %&gt;
  </pre>
  
  
  <p>It should replace the line that displays the movie's title in a
  readonly field (<code>&lt;%= h(movie.title) %></code>) with a
  user-editable field. You can also remove the link to the edit page (in
  the <em>show.html.erb</em> file as well), and remove
  <em>views/movies/edit.html.erb</em> by right-clicking its icon in the
  project view, selecting <strong>Delete</strong>, and choosing "Move to
  Trash".</p>
  
  <p>Finally you need to tell your controller you're doing in-place
  editing:</p>
  
  <p>On line 2 of <em>movies_controller.rb</em> add:</p>
  
  <pre class="code">
   in_place_edit_for :movie, :title
   protect_from_forgery :except =&gt; [:set_movie_title]
  </pre>
   
  <p>Also in the controller, change the <code>edit</code> method
  so it doesn't go looking for the now-deleted <em>edit.html.erb</em>
  file:</p>
  
  <pre class="code">
  # GET /movies/1/edit
  def edit
    @movie = Movie.find(params[:id])
    respond_to do |format|
      format.html { render :action =&gt; "show" }
      format.xml  { render :xml =&gt; @movie }
    end
  end
  </pre>

  <p>Once again, run the unit and functional tests to verify
  these changes didn't break anything. They should be fine, and this would be a
  good time to verify their actions in the browser, especially
  because in-place editing is hard to verify in a functional test.
  Click on a movie title
  in the list view, and you should see the field become writable, and an
  <strong>OK</strong> button appear.  Make a change and press
  the <strong>OK</strong> button.  If you
  see a "Saving..." message in the field, and nothing else is happening,
  check the end of your <em>log/development.log file</em>.  If you're curious
  about the calls to <code>protect_from_forgery</code>, they're related to a
  security issue that was addressed in Rails 2.0, but not by the plugin.</p>
  
  <h2><a name="adding_borrower_data" id="adding_borrower_data">Adding Borrower Data</a></h2>
  
    
  <p>Now that we have a working library of DVDs, let's add the
  pieces needed to track DVDs that leave the library,
  who took them, and when they need to bring them back.</p>
  
  <p>Run <strong>Rails Tools|Generators|Migration</strong>, with a migration name of
  <code>AddBorrowerInformation</code>.</p>
  
  <p>Set the contents of 002_add_borrower_information.rb to this:</p>
  
  <pre class="code">
  class AddBorrowerInformation &lt; ActiveRecord::Migration
    def self.up
      add_column :movies, :borrower, :string, :limit =&gt; 60
      add_column :movies, :borrowed_on, :date
      add_column :movies, :due_on, :date
    end
  
    def self.down
      remove_column :movies, :borrower
      remove_column :movies, :borrowed_on
      remove_column :movies, :due_on
    end
  end
  </pre>
  
  <p>Run the <code>Rails Tools|Migrate|db:migrate</code> tool.</p>
  
  <p>Let's add another validation routine. This one's more complex: we
  want to verify that if any of the <code>borrower</code>,
  <code>borrowed_on</code>, and <code>due_on</code> fields are
  specified, they all are, and we'll do a sanity check on the value of
  <code>due_on</code>. This is to guard the case where someone hits the
  controller without going through one of our own views.</p>
  
  <p>Add this method to <em>movie.rb</em>:</p>

  <pre class="code">
  def validate
    if borrowed_on.blank? &amp;&amp; borrower.blank? &amp;&amp; due_on.blank?
      # ok
    elsif !borrowed_on.blank? &amp;&amp; !borrower.blank? &amp;&amp; !due_on.blank?
      if due_on &lt;borrowed_on
        errors.add(:due_on, "is before date-borrowed")
      end
    elsif borrowed_on.blank?
      errors.add(:borrowed_on ,"is not specified")
    elsif borrower.blank?
      errors.add(:borrower ,"is not specified")
    else
      errors.add(:due_on ,"is not specified")
    end
  end
  </pre>
  
  <p>Add this test to <em>movie_test.rb</em>:</p>

  
  <pre class="code">
  def test_borrower
    m = Movie.create(:title =&gt; "House")
    m.borrowed_on = Date.today
    assert !m.valid?
    m.borrower = "Dave"
    assert !m.valid?
    m.due_on = Date.yesterday
    assert !m.valid?
    m.due_on = m.borrowed_on + 3
    assert m.valid?
    
    # Now clear the borrower
    m.borrower = ""
    assert !m.valid?
  end
  </pre>

  <p>The unit and functional tests should all pass.</p>

  <h2><a name="handling_checkouts" id="handling_checkouts">Handling Checkouts</a></h2>
  
  <p>We're almost done.  Let's outline the remaining pieces, since we're now moving
  away from the code Rails generated for us:</p>
  
  <ol>
    <li>Add a <code>checkout</code> method and <code>checkout</code> screen</li>
    <li>Add a <code>return</code> method</li>
    <li>Show the details in the list view</li>
  </ol>

  <p>Here's the RHTML for the checkout screen.  Create the
  file <em>app/views/movies/checkout.html.erb</em> with this
  code.  One way to create this file is to right-click
  the <em>app/views/movies</em> folder and select "Add New File..."</p>

  <pre class="code">
    &lt;h1>Checkout a movie&lt;/h1>
    &lt;p&gt;Title: &lt;%= h @movie.title %&gt;&lt;/p&gt;
    &lt;% form_tag :action =&gt; 'checkout', :id =&gt; @movie do %&gt;
      &lt;p&gt;Your name: &lt;%= text_field(:movie, :borrower) %&gt;
      &lt;%= submit_tag 'Check out' %&gt;
    &lt;% end %&gt;
    &lt;%= link_to 'Back to the library', movies_path %&gt;
  </pre>

  <p>You might have noticed that we accept any name to be typed in the
  form. We can get away with this because we're building a lending
  library that our friends will use. In a public application you would
  need to build a separate table to track members, and another one to
  handle login status, and then you'd have to deal with issues like
  password hashing and email address verification. All good information,
  and interesting, but beyond the scope of this tutorial. See the
  references section for more info.</p>

  <p>Here are the two new methods we need to add to the
  <em>movies_controller.rb</em>:</p>
  
  <pre class="code">
   # Non-Rest methods
   def checkout
     @movie = Movie.find(params[:id])
     if request.post?
       # It's an update
       @movie.borrower = params[:movie][borrower]
       @movie.borrowed_on = today = Date.today
       @movie.due_on = today + 7
       if @movie.save
         flash[:notice] = 'Movie was successfully created.'
         redirect_to(movies_url)
       else
         render :action =&gt; "checkout"
       end
     else
       # Render the template, the default
     end
   end
  
   def return
     @movie = Movie.find(params[:id])
     @movie.borrower = @movie.borrowed_on = @movie.due_on = nil
     @movie.save!
     redirect_to(movies_url)
   end
  </pre>
  
  <p>I assume HTML output to simplify the code.  If you want you can
  add the <code>respond_to</code> and <code>format</code> statements.  Note how we overload
  the <code>checkout</code> method -- if it's part of a <code>get</code> request, we render
  the form.  Otherwise we assume we're processing the submitted form.</p>
  
  <p>Finally we update the list view in <em>index.html.erb</em>:</p>

  <pre class="code">
  &lt;h2>Movies&lt;/h2&gt;
  
  &lt;table&gt;
    &lt;tr&gt;
      &lt;th class="dvdlib_header"&gt;Title&lt;/th&gt;
      &lt;th class="dvdlib_header"&gt;Status&lt;/th&gt;
    &lt;/tr&gt;
   &lt;% for movie in @movies %&gt;
    &lt;tr&gt;
      &lt;td class="dvdlib_item"&gt;
       &lt;% @movie = movie %&gt;
       &lt;%= in_place_editor_field :movie, :title %&gt;
     &lt;/td&gt;
      &lt;% if movie.borrower %&gt;
      &lt;td class="dvdlib_item"&gt;Signed out by: &lt;%= h movie.borrower %&gt;&lt;/td&gt;
      &lt;td class="dvdlib_item"&gt;Due &lt;%= h movie.due_on %&gt;&lt;/td&gt;
      &lt;td class="dvdlib_item"&gt;&lt;%= link_to 'Return', :action =&gt; 'return', :id =&gt; movie %&gt;&lt;/td&gt;
      &lt;% else %&gt;
      &lt;td class="dvdlib_item"&gt;&lt;%= link_to 'Check out', :action =&gt; 'checkout', :id =&gt; movie %&gt;&lt;/td&gt;
      &lt;td class="dvdlib_item"&gt;&lt;%= link_to 'Remove', { :action =&gt; 'destroy', :id =&gt; movie },
         :confirm =&gt; 'Are you sure?', :method =&gt; :delete %&gt;&lt;/td&gt;
      &lt;% end %&gt;
    &lt;/tr&gt;
   &lt;% end %&gt;
  &lt;/table&gt;
  &lt;% if @movies.size &gt; 0 -%&gt;
  &lt;br /&gt;
  &lt;%= will_paginate(@movies) %&gt;
  &lt;% end %&gt;
  &lt;br /&gt;
  &lt;%= link_to 'Add new movie', new_movie_path %&gt;
  </pre>
  
  <p>Add two tests to <em>movies_controller_test.rb</em> to verify that everything
  is working correctly:</p>
  
  <pre class="code">
  def test_checkout_get
    get :checkout, :id =&gt; movies(:one).id
    assert_response :success
  end

  def test_checkout_put
    post :checkout, :id =&gt; movies(:one).id, :movie =&gt; {:borrower =&gt; "Fred"}
    assert_redirected_to movies_path
  end
  </pre>
  
  <p>We were expecting no errors, but this time we get an
  <code>undefined local variable or method error</code> for
  <code>borrower</code> at around line 97-99 of
  <em>movie_controller.rb</em>. Sure enough, we forgot to put a ":"
  before the param name "borrower". Change it to <code>:borrower</code>,
  rerun the tests, and they should pass.</p>
  
  <p>People familiar with the first version of this tutorial will recall
  firing up the debugger to correct a problem like this. Writing tests
  is more efficient. You can debug Rails apps if you need to, though.
  Press the <code>Rails Tools|Run|debug rails app</code> tool, set
  breakpoints at the points in the controllers and views you're
  interested in, and then hit them with your application.</p>
  
  <p>Finally, fire up the server one more time, and verify that your
  application now works as you expect. You're ready to take this one
  live.</p>

  <h2><a name="rails_resources" id="rails_resources">Rails
  Resources</a></h2>

  <h3>Tutorials and Reference Sites</h3>

  <ul>
    <li><a target="_blank" href="http://www.rubyonrails.org/">Ruby
    on Rails</a>: The home page of the Ruby on Rails project. Links
    to downloads, documentation and other resources.</li>

    <li><a target="_blank" href=
    "http://www.onlamp.com/pub/a/onlamp/2006/12/14/revisiting-ruby-on-rails-revisited.html">
    Rolling with Ruby on Rails (Revisited)</a>: A Windows-based
    tutorial by Bill Walton and Curt Hibbs.</li>

    <li><a target="_blank" href=
    "http://instantrails.rubyforge.org/wiki/wiki.pl">Instant
    Rails</a>: An all-in-one bundle for windows containing Ruby,
    Rails, Apache, and MySQL.</li>

    <li><a target="_blank" href=
    "http://www.softwaredeveloper.com/features/74-ruby-on-rails-resources-tutorials-050207/">
    74 Quality Ruby on Rails Resources and Tutorials</a>: An
    excellent compendium of Rails resources.</li>
    
    <li><a target="_blank" href=
    "http://railscasts.com/episodes/80">Simplify Views with Rails 2.0</a>:
    A screencast covering the resource-based approach to building a web application
    with Rails 2.0.</li>
  </ul>
  <hr />
</body>
</html>
